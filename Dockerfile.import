FROM ubuntu:noble

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages for repository setup
RUN apt-get update && apt-get install --no-install-recommends -y \
    ca-certificates curl gnupg lsb-release wget && rm -rf /var/lib/apt/lists/*

# Install osm2pgsql from source (newer version with flex support)
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    libboost-dev \
    libboost-filesystem-dev \
    libboost-system-dev \
    libboost-thread-dev \
    libexpat1-dev \
    libbz2-dev \
    libpq-dev \
    libproj-dev \
    postgresql-server-dev-all \
    zlib1g-dev \
    lua5.2-dev \
    postgresql-client \
    python3-yaml \
    python3-requests \
    python3-psycopg2 \
    gdal-bin \
    git \
    nlohmann-json3-dev \
    && rm -rf /var/lib/apt/lists/*

# Add OpenStreetMap APT repository and install osm2pgsql
RUN wget -qO - https://apt.openstreetmap.org/gpg.key | gpg --dearmor -o /usr/share/keyrings/osm.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/osm.gpg] http://apt.openstreetmap.org/ $(lsb_release -sc) main" | tee /etc/apt/sources.list.d/osm.list && \
    apt-get update && \
    apt-get install --no-install-recommends -y osm2pgsql && \
    rm -rf /var/lib/apt/lists/*

ADD openstreetmap-carto-flex.lua /

RUN mkdir -p /openstreetmap-carto
WORKDIR /openstreetmap-carto

CMD sh scripts/docker-startup.sh import
